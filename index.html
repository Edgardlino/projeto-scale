<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto IoT</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #00d2ff; --text: #e0e0e0; --danger: #ff4b2b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        
        .card { background: var(--card); width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; color: #666; font-size: 0.9rem; }
        .status-dot { height: 10px; width: 10px; background: #444; border-radius: 50%; display: inline-block; }
        .connected { background: var(--primary); box-shadow: 0 0 10px var(--primary); }

        /* Peso */
        .weight-box { background: #000; border-radius: 10px; padding: 20px; margin: 20px 0; border: 1px solid #333; position: relative; }
        .value { font-size: 4rem; font-weight: bold; color: var(--primary); font-family: monospace; }
        .unit { position: absolute; bottom: 15px; right: 20px; color: #666; }

        /* Bateria */
        .bat-box { display: flex; align-items: center; gap: 5px; justify-content: flex-end; }
        .bat-icon { width: 20px; height: 10px; border: 2px solid #666; position: relative; padding: 1px; }
        .bat-fill { height: 100%; background: #00b09b; width: 0%; transition: 0.3s; }
        .bat-icon::after { content: ''; position: absolute; right: -4px; top: 2px; width: 2px; height: 6px; background: #666; }

        /* Bot√µes */
        button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; transition: 0.2s; }
        .btn-connect { background: #333; color: var(--primary); border: 1px solid var(--primary); }
        .btn-tare { background: linear-gradient(135deg, #f39c12, #d35400); }
        .btn-cal { background: #333; color: #777; font-size: 0.8rem; padding: 10px; margin-top: 20px; }
        .btn-cloud { background: #27ae60; margin-bottom: 5px; display: none; }
        .btn-hist { background: #8e44ad; display: none; } /* Bot√£o Hist√≥rico */

        /* Calibra√ß√£o (Escondido) */
        #cal-area { display: none; margin-top: 15px; background: #252525; padding: 15px; border-radius: 10px; }
        input { background: #333; border: 1px solid #555; color: white; padding: 10px; width: 60%; border-radius: 5px; text-align: center; }
        .btn-save { background: var(--primary); margin-top: 5px; }

        /* MODAL DE HIST√ìRICO */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 15px; width: 95%; max-width: 500px; max-height: 80vh; overflow-y: auto; border: 1px solid #333; color: #ddd; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: #666; cursor: pointer; }
        
        /* Tabela */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th { text-align: left; border-bottom: 1px solid #444; color: var(--primary); padding: 5px; }
        td { border-bottom: 1px solid #333; padding: 8px 5px; }
        tr:last-child td { border: none; }
    </style>
</head>
<body>

    <div class="card">
        <div class="header">
            <span>PROJETO BLE</span>
            <div class="bat-box">
                <span id="bat-txt">--%</span>
                <div class="bat-icon"><div id="bat-fill" class="bat-fill"></div></div>
                <span id="status-dot" class="status-dot"></span>
            </div>
        </div>

        <div class="weight-box">
            <span id="weight">---</span>
            <span class="unit">g</span>
        </div>

        <button id="btn-bt" class="btn-connect" onclick="connectBLE()">üîó CONECTAR BALAN√áA</button>
        
        <button id="btn-cloud" class="btn-cloud" onclick="saveToCloud()">‚òÅÔ∏è SALVAR NA NUVEM</button>
        <button id="btn-hist" class="btn-hist" onclick="loadHistory()">üìú VER HIST√ìRICO</button>
        
        <button id="btn-tare" class="btn-tare" onclick="sendCommand('TARE')" disabled>ZERAR (TARA)</button>

        <button class="btn-cal" onclick="toggleCal()">Configura√ß√µes</button>
        <div id="cal-area">
            <p style="color:#aaa; font-size:0.8rem">Coloque um peso conhecido:</p>
            <input type="number" id="cal-weight" placeholder="Ex: 1000">
            <button class="btn-save" onclick="calibrate()">CALIBRAR</button>
        </div>
    </div>

    <div id="histModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Hist√≥rico de Pesagem</h3>
            <div id="loading" style="text-align:center; color:#888;">Carregando dados...</div>
            <table id="hist-table" style="display:none;">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Peso (g)</th>
                        <th>Bat</th>
                    </tr>
                </thead>
                <tbody id="hist-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- COLOQUE SEU LINK DO GOOGLE SCRIPT AQUI ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbywhp8dTqHn9oGgIk3P4fQ8QsVK6QINHUKJmvmWb5FGikMxAuXDY82XvyMCJRXjAnaq9A/exec"; 

        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHAR_DATA_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        const CHAR_CMD_UUID = "129e7192-36e1-4688-b7f5-ea07361b26a8";

        let device, server, service, charData, charCmd;
        let currentWeight = 0;
        let currentBat = 0;

        async function connectBLE() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Projeto Scale' }],
                    optionalServices: [SERVICE_UUID]
                });
                document.getElementById('btn-bt').innerText = "Conectando...";
                server = await device.gatt.connect();
                service = await server.getPrimaryService(SERVICE_UUID);
                charData = await service.getCharacteristic(CHAR_DATA_UUID);
                charCmd = await service.getCharacteristic(CHAR_CMD_UUID);

                await charData.startNotifications();
                charData.addEventListener('characteristicvaluechanged', handleData);

                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('btn-bt').style.display = 'none';
                
                document.getElementById('btn-cloud').style.display = 'block';
                document.getElementById('btn-hist').style.display = 'block';
                document.getElementById('btn-tare').disabled = false;
                
                device.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                alert("Erro: " + error);
                document.getElementById('btn-bt').innerText = "üîó CONECTAR BALAN√áA";
            }
        }

        function handleData(event) {
            let enc = new TextDecoder();
            let data = enc.decode(event.target.value);
            let parts = data.split('|');
            if(parts.length === 2) {
                currentWeight = parts[0];
                currentBat = parseInt(parts[1]);
                document.getElementById('weight').innerText = currentWeight;
                updateBattery(currentBat);
            }
        }

        // --- SALVAR ---
        function saveToCloud() {
            if(currentWeight == 0 || currentWeight == "---") return alert("Sem peso para salvar!");
            let btn = document.getElementById('btn-cloud');
            btn.innerText = "Enviando..."; btn.disabled = true;

            fetch(GOOGLE_SCRIPT_URL + `?peso=${currentWeight}&bat=${currentBat}`, { mode: 'no-cors' })
            .then(() => {
                alert(`Salvo!`);
                btn.innerText = "‚òÅÔ∏è SALVAR NA NUVEM"; btn.disabled = false;
            }).catch(e => {
                alert("Erro: " + e);
                btn.innerText = "‚òÅÔ∏è SALVAR NA NUVEM"; btn.disabled = false;
            });
        }

O problema √© que o JavaScript do navegador tenta "adivinhar" o formato da data. Quando ele recebe 08/12/2025, ele pensa que √© Agosto (M√™s 08) dia 12, pois o padr√£o internacional da programa√ß√£o √© M√™s/Dia. Por isso ele inverte e mostra 12/8 (Dia 12 do m√™s 8).

Para resolver de vez, vamos parar de pedir para o navegador interpretar a data (new Date) e vamos tratar ela apenas como Texto.

Substitua a fun√ß√£o loadHistory no seu c√≥digo HTML por esta vers√£o corrigida. Ela pega exatamente o que est√° escrito e corta os peda√ßos, sem tentar "pensar" se √© m√™s ou dia.

A Corre√ß√£o (Copie e substitua no seu index.html)
JavaScript

        // --- LER HIST√ìRICO (CORRIGIDO PARA DATA BR) ---
        function loadHistory() {
            const m = document.getElementById('histModal');
            m.style.display = 'flex';
            const tbody = document.getElementById('hist-body');
            tbody.innerHTML = ''; 
            document.getElementById('loading').style.display = 'block';
            document.getElementById('hist-table').style.display = 'none';

            fetch(GOOGLE_SCRIPT_URL + "?action=read")
            .then(r => r.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('hist-table').style.display = 'table';
                
                // Pega os √∫ltimos 15
                let ultimos = data.slice(1).slice(-15).reverse(); 

                ultimos.forEach(row => {
                    // O Google manda: row[0] = "08/12/2025" (Texto)
                    //                 row[1] = "14:55" (Texto)
                    
                    // Tratamento como TEXTO puro (Sem new Date)
                    // Pega os primeiros 5 caracteres: "08/12"
                    let diaMes = row[0].substring(0, 5); 
                    
                    // Se por acaso vier no formato americano (YYYY-MM-DD), previne erro:
                    if (row[0].indexOf('-') > -1) {
                       let partes = row[0].split('-'); // 2025-12-08
                       diaMes = partes[2] + "/" + partes[1];
                    }

                    let hora = row[1]; // "14:55"
                    
                    // Monta a string final
                    let dataFinal = diaMes + " " + hora;
                    
                    let tr = `<tr>
                        <td>${dataFinal}</td>
                        <td style="font-weight:bold; color:white">${row[2]}</td>
                        <td style="color:#aaa">${row[3]}%</td>
                    </tr>`;
                    tbody.innerHTML += tr;
                });
            })
            .catch(e => {
                document.getElementById('loading').innerText = "Erro ao carregar.";
                console.log(e);
            });
        }

        function closeModal() {
            document.getElementById('histModal').style.display = 'none';
        }

        // --- UTILS ---
        async function sendCommand(cmd) { if (charCmd) { let enc = new TextEncoder(); await charCmd.writeValue(enc.encode(cmd)); } }
        
        function calibrate() {
            let w = document.getElementById('cal-weight').value;
            if(w && confirm(`Calibrar com ${w}g?`)) { sendCommand(`CAL:${w}`); toggleCal(); alert("Enviado!"); }
        }

        function onDisconnected() {
            document.getElementById('status-dot').classList.remove('connected');
            document.getElementById('btn-bt').style.display = 'block';
            document.getElementById('btn-cloud').style.display = 'none';
            document.getElementById('btn-hist').style.display = 'none';
            document.getElementById('btn-tare').disabled = true;
        }

        function updateBattery(pct) {
            document.getElementById('bat-txt').innerText = pct + "%";
            let fill = document.getElementById('bat-fill');
            fill.style.width = pct + "%";
            fill.style.backgroundColor = pct < 20 ? '#ff4b2b' : '#00b09b';
        }

        function toggleCal() {
            let el = document.getElementById('cal-area');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }
        
        window.onclick = function(e) { if (e.target == document.getElementById('histModal')) closeModal(); }
    </script>
</body>
</html>
